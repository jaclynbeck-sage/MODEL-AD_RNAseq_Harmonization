---
title: "V1 MAPT + Base Genome Benchmark Analysis"
author: "Jaclyn Beck (Sage Bionetworks)"
output:
  html_document: 
    code_folding: hide
    highlight: pygments
    embed-resources: true
    toc: true
    df_print: default
    toc_depth: 1
  md_document: 
    pandoc_args: ["--wrap=preserve"]
---

```{r optional-wiki-setup, echo=FALSE, results="asis", eval=FALSE}
# Change this code chunk to "eval=TRUE" when knitting to a Synapse wiki to
# remove code from the render. This also makes the plots print out in higher
# quality than default for the wiki.

options(knitr.table.format = "pipe")
knitr::opts_chunk$set(echo = FALSE)

# This resolution and aspect ratio, scaled to ~45% on the wiki, looks good
knitr::opts_chunk$set(dpi = 300)
knitr::opts_chunk$set(fig.height = 4)
knitr::opts_chunk$set(fig.width = 7)

# Prints out a markdown header for the Synapse wiki and a reminder to download
# the HTML file for inline code display
cat("#! V1 MAPT + Base Genome Benchmark Analysis\n\n")
cat("**Author:** Jaclyn Beck (Sage Bionetworks)\n\n")
cat("> **Note:** This wiki page shows the output of the R notebook but with",
    "inline code removed. **Download the rendered HTML file** with the",
    "`Download Options` button to view the notebook with code inserted.",
    "\n\n", "${toc}", "\n\n") # wiki table of contents
```

# Methods

I generated a custom genome using the methods described in [V1 Genome Benchmark Analysis](https://www.synapse.org/Synapse:syn73455492), however only human MAPT was added to the base mouse genome. All samples were aligned to the MAPT+ genome, and compared to the alignment with the base genome.

This benchmarking case tries to isolate the effect of adding the human MAPT gene on alignment.

# Setup

Read in metadata, processed counts files, and gene symbol file. Subset metadata to only the samples present in the counts files.

```{r message=FALSE, warning=FALSE, results='hide'}

library(stringr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(RColorBrewer)
library(synapser)
library(patchwork)
library(knitr)
library(kableExtra)

setwd("..")

synLogin(silent = TRUE)

# Use V3 of the metadata, which uses the old Jax specimen IDs corresponding to
# what is in the benchmark files
meta_file <- synGet("syn61850266.3", downloadLocation = file.path("data", "tmp"))
metadata <- read.csv(meta_file$path)

# Necessary because R puts an "X" in front of any specimen IDs that start with
# a number to make column names
metadata$specimenID_X <- make.names(metadata$specimenID)

# Use V1 of the benchmark files, which do not include CLU tests
base_file <- synGet("syn61806059.1", downloadLocation = file.path("data", "tmp"))
counts_base <- read.table(base_file$path, sep = "\t", header = TRUE) |>
  select(-transcript_id.s.)

mapt_file <- synGet("syn61806426.1", downloadLocation = file.path("data", "tmp"))
counts_mapt <- read.table(mapt_file$path, sep = "\t", header = TRUE) |>
  select(-transcript_id.s.)

metadata <- subset(metadata, specimenID_X %in% colnames(counts_base)) |>
  select(individualID, specimenID, specimenID_X, genotype, study_name) |>
  # Shorten "APOE4-KI_homozygous; Trem2-R47H_homozygous" genotype to "LOAD1"
  mutate(genotype = ifelse(genotype == "APOE4-KI_homozygous; Trem2-R47H_homozygous",
                           "LOAD1", genotype))

symbol_file <- synGet("syn62063692", downloadLocation = file.path("data", "tmp"))
gene_symbols <- read.csv(symbol_file$path)
```

Set up plot themes

```{r}
bold_labels <- theme(title = element_text(face = "bold"),
                     axis.title = element_text(face = "bold"))

legend_bottom <- theme(legend.position = "bottom")

angled_x_axis <- theme(axis.text.x = element_text(angle = 90, hjust = 1, 
                                                  vjust = 0.5))

left_margin <- theme(plot.margin = unit(c(0, 0, 0, 50), units = "pt"))

facet_style <- theme(strip.background = element_rect(fill = "#EFEFEF"),
                     strip.text = element_text(face = "bold"))
```

# Quality checks

Check that:

-   The MAPT+ genome contains human genes, and the base genome doesn't
-   All human genes start with "ENSG" and all mouse genes start with "ENSM"
-   No genes are in the base genome that don't exist in the MAPT+ genome
-   All samples are present in both matrices

```{r}
# Check for existence of human genes
human_genes <- setdiff(counts_mapt$gene_id, counts_base$gene_id)
mouse_genes <- intersect(counts_base$gene_id, counts_mapt$gene_id)

cat("Genes present in MAPT+ genome that are not in base genome:", "\n",
    paste(human_genes, collapse = ", "), "\n")

# Naming of human and mouse genes
stopifnot(all(str_detect(human_genes, "ENSG")))
cat("All human genes start with 'ENSG'.", "\n")
stopifnot(all(str_detect(mouse_genes, "ENSM")))
cat("All mouse genes start with 'ENSM'", "\n")

# All mouse genes present in both genomes
stopifnot(length(setdiff(counts_base$gene_id, counts_mapt$gene_id)) == 0)
cat("All genes in base genome are present in MAPT+ genome.", "\n")

# All samples present
stopifnot(all(colnames(counts_base) %in% colnames(counts_mapt)))
cat("All samples are present in both counts matrices.", "\n")
```

# How many counts are identical or different between matrices?

Ensure that both matrices have samples in the same order, and create data frames that only include mouse genes for this analysis.

```{r message=FALSE}
rownames(counts_base) <- counts_base$gene_id
rownames(counts_mapt) <- counts_mapt$gene_id
counts_mapt <- counts_mapt[, colnames(counts_base)]

df_base <- melt(counts_base[mouse_genes, ], 
                variable.name = "sample", 
                value.name = "count")
df_mapt <- melt(counts_mapt[mouse_genes, ], 
                variable.name = "sample", 
                value.name = "count")
```

Some stats on identical counts vs mismatched counts:

```{r}
pct <- 100 * sum(df_base$count == df_mapt$count) / nrow(df_base)
cat("Identical counts between matrices:", 
    sum(df_base$count == df_mapt$count), 
    "of", nrow(df_base), 
    paste0("(", round(pct, digits = 2), "%)"), "\n")

cat("Mismatched counts between matrices:", 
    sum(df_base$count != df_mapt$count), 
    "of", nrow(df_base), 
    paste0("(", round(100-pct, digits = 2), "%)"), "\n")

df_combined <- subset(df_base, df_base$count != df_mapt$count) |>
  merge(df_mapt, by = c("gene_id", "sample")) |>
  dplyr::rename(count_base = "count.x", count_mapt = "count.y") |>
  mutate(difference = count_base - count_mapt)

cat("Correlation between mismatches: R^2 =", 
    cor(df_combined$count_base, df_combined$count_mapt)^2, "\n")

cat("Mean mismatch difference:", 
    mean(abs(df_combined$difference)), "counts \n")
```

## How many entries have a difference of \> 1 count?

RSEM returns decimal numbers when reads are ambiguous, so the differences are sometimes not integers. We consider a count difference \<= 1 to be trivial and ignore it in further analysis.

```{r}
df_combined <- merge(df_combined, metadata, by.x = "sample", by.y = "specimenID_X")

diff_counts_gt1 <- which(abs(df_combined$difference) > 1)

cat(length(diff_counts_gt1), "of", nrow(df_combined), 
    "differences are greater than 1 count.")
```

# Examining mouse gene count differences for differences \> 1 count

## By study

```{r}
ggplot(df_combined[diff_counts_gt1, ], 
       aes(x = count_base+1, y = abs(difference), color = study_name)) + 
  geom_point(size = 0.5) + scale_x_log10() + scale_y_log10() + 
  theme_bw() + legend_bottom + bold_labels +
  scale_color_brewer(palette = "Set1", name = "Study") +
  ggtitle("Count differences between reference genomes (for differences > 1)") + 
  xlab("Counts (aligned with base mouse genome)") + 
  ylab("Difference from MAPT+ genome")
```

## By genotype

```{r}
ggplot(df_combined[diff_counts_gt1, ], 
       aes(x = count_base+1, y = abs(difference), color = genotype)) + 
  geom_point(size = 0.5) + scale_x_log10() + scale_y_log10() + 
  theme_bw() + 
  legend_bottom + bold_labels +
  theme(legend.text = element_text(size = 6)) + 
  guides(color = guide_legend(nrow = 2, keywidth = 0.2)) + 
  scale_color_brewer(palette = "Dark2", name = "Genotype") + 
  ggtitle("Count differences between reference genomes (for differences > 1)") + 
  xlab("Counts (aligned with base mouse genome)") + 
  ylab("Difference from MAPT+ genome") 
```

## Histograms: Genes vs Samples

For each sample, how many genes have a count difference \> 1 between the base mouse genome and the MAPT+ genome?

```{r}
diff_samps <- table(df_combined$specimenID[diff_counts_gt1])
diff_samps <- as.data.frame(diff_samps) |>
  rename(Sample = Var1, Genes = Freq)

plt_g_per_s <- ggplot(diff_samps, aes(x = Genes)) + 
  geom_histogram(bins = 20, color = "black", fill = "lightskyblue") + 
  theme_bw() + xlab("Number of different genes") +
  bold_labels +
  ggtitle("Number of different genes \nper sample")
```

For each gene, how many samples have a count difference \> 1 between the base mouse genome and the MAPT+ genome?

```{r}
diff_genes <- table(df_combined$gene_id[diff_counts_gt1])
diff_genes <- as.data.frame(diff_genes) |>
  rename(Gene = Var1, Samples = Freq)

plt_s_per_g <- ggplot(diff_genes, aes(x = Samples)) + 
  geom_histogram(bins = 20, color = "black", fill = "thistle") + 
  theme_bw() + xlab("Number of different samples") +
  ggtitle("Number of different samples \nper gene") + 
  bold_labels + left_margin
```

```{r}
print(plt_g_per_s + plt_s_per_g)
```

## Histogram: differences by genotype

For each genotype, how many entries in the matrix (over all samples and genes) have a count difference \> 1 between the base mouse genome and the MAPT+ genome?

```{r}
diff_geno <- table(df_combined$genotype[diff_counts_gt1])
diff_geno <- as.data.frame(diff_geno) |>
  rename(Genotype = Var1, Entries = Freq)

plt_e_per_g <- ggplot(diff_geno, aes(x = Genotype, y = Entries)) + 
  geom_col(color = "black", fill = "darkseagreen3") + 
  theme_bw() + ylab("Matrix entries") +
  bold_labels + angled_x_axis +
  ggtitle("Number of different matrix \nentries per genotype")
```

For each genotype, how many unique genes have a count difference \> 1 in any sample between the base mouse genome and the MAPT+ genome?

```{r}
diff_geno2 <- df_combined[diff_counts_gt1, ] |> 
  select(gene_id, genotype) |>
  distinct()
diff_geno2 <- table(diff_geno2$genotype)
diff_geno2 <- as.data.frame(diff_geno2) |>
  rename(Genotype = Var1, Genes = Freq)

plt_g_per_g <- ggplot(diff_geno2, aes(x = Genotype, y = Genes)) + 
  geom_col(color = "black", fill = "salmon2") + 
  theme_bw() +
  bold_labels + angled_x_axis + left_margin +
  ggtitle("Number of unique genes \nchanged per genotype")
```

```{r}
print(plt_e_per_g + plt_g_per_g)
```

# Focusing on differences of \> 10 counts

Note that from the graphs above, the only entries with \> 10 counts of difference between the base mouse genome and the MAPT+ genome are entries with between 1,000 and 1,000,000 total counts, representing a margin of 1% to 0.001% difference.

## Which genotypes have more than a 10 count difference for any gene or sample?

```{r}
df_tmp <- subset(df_combined, abs(difference) > 10) |>
  group_by(genotype) |>
  summarize(n_differences = n())

kable(df_tmp) |> kable_styling(full_width = FALSE)
```

## How many unique genes is this?

```{r}
df_tmp <- subset(df_combined, abs(difference) > 10) |>
  group_by(gene_id) |>
  summarize(n_differences = n())

cat(nrow(df_tmp), "unique genes have at least one sample with a",
    "> 10 count difference.", "\n")
```

# Examining humanized gene expression

## Setup

Create a data frame with gene expression from humanized genes and mouse orthologs from the counts aligned with the MAPT+ genome, and the mouse orthologs from the counts aligned with the base genome. Give human genes and their mouse orthologs recognizable gene names.

```{r message=FALSE}
id_map <- c("ENSMUSG00000018411" = "MAPT",
            "ENSG00000186868" = "MAPT")

base_tmp <- melt(counts_base[names(id_map)[1], ],
                 variable.name = "sample", 
                 value.name = "count") |>
  mutate(gene_source = "Mouse Mapt (base genome)")

df_human <- melt(counts_mapt[names(id_map), ], 
                 variable.name = "sample", 
                 value.name = "count") |>
  mutate(gene_source = "Mouse Mapt (MAPT+ genome)") |>
  rbind(base_tmp) |>
  merge(metadata, by.x = "sample", by.y = "specimenID_X")

df_human$gene_name <- id_map[df_human$gene_id]
df_human$gene_source[grepl("ENSG", df_human$gene_id)] <- "Human MAPT"
```

Mark which genotypes have which humanized genes, for plotting.

```{r}
df_human$humanized_MAPT <- df_human$genotype %in% c("3xTg-AD_carrier")
```

## Gene expression (emphasis on humanized MAPT genotypes)

Only the *3xTg-AD_carrier* genotype (which has hMAPT) has a significant number of detected counts of hMAPT, as expected. Humanized MAPT was added to the genome with no alterations to the mouse *Mapt* gene, so it is expected that levels of mouse *Mapt* for these mice would be comparable to noncarrier genotypes.

```{r}
mapt_counts <- subset(df_human, gene_id == "ENSG00000186868") |>
  group_by(genotype) |>
  summarize(max_hMAPT = round(max(count)),
            n_detected_hMAPT = sum(count > 0))
kable(mapt_counts) |> kable_styling(full_width = FALSE)
```

```{r, fig.height=6}
ggplot(df_human, aes(x = genotype, y = count+1, color = humanized_MAPT)) +
  geom_jitter(width = 0.2) + scale_y_log10(na.value = 0) + 
  facet_wrap(~gene_source) +
  theme_bw() + 
  ylab("count") + 
  scale_color_manual(values = c("darkgray", "palevioletred"),
                     name = "Has humanized MAPT") +
  bold_labels + angled_x_axis + legend_bottom + facet_style +
  ggtitle("Gene expression, emphasis on genotypes with hMAPT")
```

# Which mouse genes specifically are changed between references?

```{r warning=FALSE}
gene_symbols <- subset(gene_symbols, 
                       ensembl_gene_id %in% df_combined[diff_counts_gt1, "gene_id"])

df_per_geno <- df_combined[diff_counts_gt1,] |> 
  group_by(genotype) |>
  summarize(gene_ids = list(unique(gene_id)))

for (geno in df_per_geno$genotype) {
  ids <- df_per_geno$gene_ids[df_per_geno$genotype == geno][[1]]
  genes <- subset(gene_symbols, ensembl_gene_id %in% ids)
  cat(geno, "\n")
  print(sort(genes$gene_symbol))
  cat("\n\n")
}
```

Filter out non-coding RNA, mitochondrial genes, ribosomal genes, un-annotated genes, and pseudogenes from this list.

```{r}
for (geno in df_per_geno$genotype) {
  ids <- df_per_geno$gene_ids[df_per_geno$genotype == geno][[1]]
  genes <- subset(gene_symbols, ensembl_gene_id %in% ids & gene_symbol != "")
  genes <- genes[!grepl("-ps|mt-|^Rp|^Rn[0-9]|^Gm[0-9]+|^[0-9]+", genes$gene_symbol), ]
  cat(geno, "\n")
  print(sort(genes$gene_symbol))
  cat("\n\n")
}
```

**What are the 3 genes with count differences \> 10?**

```{r}
df_tmp <- subset(df_combined, abs(difference) > 10) |>
  group_by(gene_id) |>
  summarize(n_differences = n())

genes <- subset(gene_symbols, ensembl_gene_id %in% df_tmp$gene_id)
print(sort(genes$gene_symbol))
```

Several expression differences of these genes appear to be near-direct swaps between Rn7s1 and Rn7s2 within the same sample, and the only mouse Mapt changes appear in 3xTg_AD carriers:

```{r}
df_tmp2 <- subset(df_combined, abs(difference) > 10) |>
  merge(gene_symbols, by.x = "gene_id", by.y = "ensembl_gene_id") |>
  select(gene_id, gene_symbol, difference, specimenID, genotype) |>
  arrange(specimenID)

kable(df_tmp2) |> kable_styling(full_width = FALSE)
```

# Conclusion

-   Detection of human MAPT appears consistent with each mouse genotype.
-   Detection of mouse *Mapt* is similar between the base mouse genome and the MAPT+ genome, and expression levels are as expected across genotypes.
-   Adding humanized genes to the reference changes expression for a small number of genes:
    -   the majority of these genes are pseudogenes, mitochondrial, ribosomal, un-annotated, or non-coding RNAs.
-   These changes are so minor that it is safe to conclude that **adding human MAPT to the genome doesn't significantly affect alignment**.

```{r}
# Get some statistics on the scope of gene changes per genotype
df_gt1 <- df_combined[diff_counts_gt1,] |>
  subset(!(gene_id %in% names(id_map))) # Remove human genes + mouse orthologs
df_gt1$control <- grepl("noncarrier", df_gt1$genotype)
df_gt1$control[df_gt1$genotype == "Trem2-R47H_homozygous"] = TRUE
df_gt1$apoe <- grepl("APOE4-KI_homozygous", df_gt1$genotype)

stats_by_genotype <- df_gt1 |> group_by(control, genotype) |> 
  summarize(n_genes = length(unique(gene_id)), 
            median = median(abs(difference)), 
            max = max(abs(difference)),
            .groups = "drop")
kable(stats_by_genotype) |> kable_styling(full_width = FALSE)
```

```{r upload, eval=FALSE, include=FALSE}
# Code to add this notebook's rendered contents to a wiki page on Synapse, which
# makes it nicely viewable. The wiki belongs to the rendered HTML file that was
# uploaded to Synapse.
#
# NOTE: Images still need to be re-scaled on Synapse at this time because the
# knit2synapse library currently assumes the scaling should always be 100%. The
# yaml header also needs to be manually removed from the page.
library(knit2synapse)
library(synapser)

synLogin(silent = TRUE)

knitfile2synapse(file = "V1d_MAPT_Benchmark_Analysis.Rmd",
                 owner = "syn73461800",
                 wikiName = "V1 MAPT + Base Genome Benchmark Analysis")
```
